#!/usr/bin/env bash
#
# GitHub Copilot Code Review - Pre-Commit Hook
# Automatically runs  before commits
# Blocks commits with CRITICAL issues (configurable)
#

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration file
CONFIG_FILE=".github/codereview-config.yml"

# Check if config exists
if [ ! -f "$CONFIG_FILE" ]; then
    echo -e "${YELLOW}âš ï¸  Warning: $CONFIG_FILE not found. Using default settings.${NC}"
    PRE_COMMIT_ENABLED=true
    BLOCK_ON_CRITICAL=true
else
    # Parse YAML config (simple grep-based parsing)
    PRE_COMMIT_ENABLED=$(grep -A 2 "pre_commit:" "$CONFIG_FILE" | grep "enabled:" | awk '{print $2}')
    BLOCK_ON_CRITICAL=$(grep -A 5 "pre_commit:" "$CONFIG_FILE" | grep "block_on_critical:" | awk '{print $2}')
    AUTO_RUN=$(grep -A 3 "pre_commit:" "$CONFIG_FILE" | grep "auto_run:" | awk '{print $2}')
fi

# If pre-commit hook is disabled, exit
if [ "$PRE_COMMIT_ENABLED" = "false" ]; then
    exit 0
fi

echo -e "${BLUE}ğŸ” Running Code Review Pre-Commit Hook...${NC}"

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${YELLOW}No files staged for commit.${NC}"
    exit 0
fi

# Count staged files
FILE_COUNT=$(echo "$STAGED_FILES" | wc -l | tr -d ' ')
echo -e "${BLUE}ğŸ“ Analyzing $FILE_COUNT staged file(s)...${NC}"

# Check if any staged files are in critical paths
CRITICAL_PATHS=$(grep -A 3 "critical_paths:" "$CONFIG_FILE" | grep "pattern:" | sed 's/.*pattern: "\(.*\)"/\1/' || echo "")
IN_CRITICAL_PATH=false

if [ -n "$CRITICAL_PATHS" ]; then
    while IFS= read -r pattern; do
        # Convert glob pattern to regex (simple conversion)
        pattern_regex=$(echo "$pattern" | sed 's/\*\*/.*/' | sed 's/\*/[^\/]*/')

        while IFS= read -r file; do
            if [[ "$file" =~ $pattern_regex ]]; then
                IN_CRITICAL_PATH=true
                echo -e "${RED}ğŸ”’ Critical path detected: $file${NC}"
            fi
        done <<< "$STAGED_FILES"
    done <<< "$CRITICAL_PATHS"
fi

# Check for large changes
LINE_THRESHOLD=$(grep "lines_changed_warning:" "$CONFIG_FILE" | awk '{print $2}' || echo "500")
LINES_CHANGED=$(git diff --cached --shortstat | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo "0")

if [ "$LINES_CHANGED" -gt "$LINE_THRESHOLD" ]; then
    echo -e "${YELLOW}âš ï¸  Large change detected: $LINES_CHANGED lines changed (threshold: $LINE_THRESHOLD)${NC}"
fi

# Function to run reviewcode via GitHub Copilot CLI
run_reviewcode() {
    echo -e "${BLUE}ğŸ¤– Running @reviewcode via GitHub Copilot...${NC}"

    # Check if GitHub Copilot CLI is available
    if command -v gh &> /dev/null && gh copilot --version &> /dev/null; then
        # Use GitHub Copilot CLI
        REVIEW_OUTPUT=$(gh copilot suggest "@reviewcode" 2>&1 || true)
    else
        echo -e "${YELLOW}âš ï¸  GitHub Copilot CLI not found. Please run @reviewcode manually in your IDE.${NC}"
        echo -e "${YELLOW}   Install: https://docs.github.com/en/copilot/github-copilot-in-the-cli${NC}"

        if [ "$IN_CRITICAL_PATH" = true ]; then
            echo -e "${RED}âŒ BLOCKED: Critical path requires code review.${NC}"
            echo -e "${RED}   Run @reviewcode in GitHub Copilot chat before committing.${NC}"
            exit 1
        fi

        echo -e "${YELLOW}   Commit allowed, but please review your code.${NC}"
        exit 0
    fi

    # Check if review found critical issues
    if echo "$REVIEW_OUTPUT" | grep -q "ğŸ”´ Critical:" || echo "$REVIEW_OUTPUT" | grep -q "CRITICAL"; then
        CRITICAL_COUNT=$(echo "$REVIEW_OUTPUT" | grep -o "Critical: [0-9]*" | grep -o "[0-9]*" | head -1 || echo "0")

        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${RED}âŒ COMMIT BLOCKED: $CRITICAL_COUNT Critical Issue(s) Found${NC}"
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        echo "$REVIEW_OUTPUT"
        echo ""
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${YELLOW}ğŸ“‹ Action Required:${NC}"
        echo -e "   1. Fix the critical issue(s) listed above"
        echo -e "   2. Run ${GREEN}@reviewcode${NC} again to verify fixes"
        echo -e "   3. Stage your fixes: ${GREEN}git add .${NC}"
        echo -e "   4. Try committing again: ${GREEN}git commit${NC}"
        echo ""
        echo -e "${RED}   To bypass this check (NOT RECOMMENDED): git commit --no-verify${NC}"
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

        if [ "$BLOCK_ON_CRITICAL" = "true" ]; then
            exit 1
        else
            echo -e "${YELLOW}âš ï¸  Proceeding anyway (blocking disabled in config)${NC}"
        fi
    else
        echo -e "${GREEN}âœ… Code review passed! No critical issues found.${NC}"

        # Show summary if available
        if echo "$REVIEW_OUTPUT" | grep -q "HIGH\|MEDIUM\|LOW"; then
            HIGH_COUNT=$(echo "$REVIEW_OUTPUT" | grep -o "High: [0-9]*" | grep -o "[0-9]*" | head -1 || echo "0")
            MEDIUM_COUNT=$(echo "$REVIEW_OUTPUT" | grep -o "Medium: [0-9]*" | grep -o "[0-9]*" | head -1 || echo "0")

            if [ "$HIGH_COUNT" -gt 0 ] || [ "$MEDIUM_COUNT" -gt 0 ]; then
                echo -e "${YELLOW}âš ï¸  Non-blocking issues found:${NC}"
                [ "$HIGH_COUNT" -gt 0 ] && echo -e "   ğŸŸ  High: $HIGH_COUNT"
                [ "$MEDIUM_COUNT" -gt 0 ] && echo -e "   ğŸŸ¡ Medium: $MEDIUM_COUNT"
                echo -e "   ${YELLOW}Consider fixing these before pushing.${NC}"
            fi
        fi
    fi
}

# Function to check commit message format
check_commit_msg() {
    # This runs in commit-msg hook, not here
    # But we can check staged commit message if available
    return 0
}

# Main execution
if [ "$AUTO_RUN" = "true" ] || [ "$IN_CRITICAL_PATH" = true ]; then
    run_reviewcode
elif [ "$IN_CRITICAL_PATH" = true ]; then
    echo -e "${RED}ğŸ”’ Critical path detected. Code review is REQUIRED.${NC}"
    run_reviewcode
else
    # Check if large changes
    if [ "$LINES_CHANGED" -gt "$LINE_THRESHOLD" ]; then
        echo -e "${YELLOW}âš ï¸  Large changes detected. Running code review...${NC}"
        run_reviewcode
    else
        echo -e "${BLUE}ğŸ’¡ Tip: Run @reviewcode in GitHub Copilot chat for comprehensive analysis${NC}"
        echo -e "${GREEN}âœ… Pre-commit checks passed (auto-review disabled for small changes)${NC}"
    fi
fi

# Count commits since last review (optional reminder)
COMMITS_SINCE_REVIEW=$(git log --oneline | grep -E -c "reviewcode|codereview" || echo "999")
if [ "$COMMITS_SINCE_REVIEW" -gt 5 ]; then
    echo -e "${YELLOW}ğŸ’¡ Reminder: You haven't run @reviewcode in the last 5 commits${NC}"
fi

echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ“ Pre-commit hook completed${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

exit 0
