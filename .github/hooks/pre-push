#!/usr/bin/env bash
#
# GitHub Copilot Code Review - Pre-Push Hook
# Runs @codereview on all changes before pushing to remote
# Blocks push if CRITICAL issues found
#

set -e

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

CONFIG_FILE=".github/codereview-config.yml"

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸš€ Pre-Push Code Review - Shift Left Security Check${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# Parse config
if [ -f "$CONFIG_FILE" ]; then
    PRE_PUSH_ENABLED=$(grep -A 2 "pre_push:" "$CONFIG_FILE" | grep "enabled:" | awk '{print $2}')
    BLOCK_ON_CRITICAL=$(grep -A 5 "pre_push:" "$CONFIG_FILE" | grep "block_on_critical:" | awk '{print $2}')
    AUTO_RUN=$(grep -A 3 "pre_push:" "$CONFIG_FILE" | grep "auto_run:" | awk '{print $2}')
else
    PRE_PUSH_ENABLED=true
    BLOCK_ON_CRITICAL=true
    AUTO_RUN=true
fi

if [ "$PRE_PUSH_ENABLED" = "false" ]; then
    echo -e "${YELLOW}âš ï¸  Pre-push hook disabled in config${NC}"
    exit 0
fi

# Get remote name and URL
while read local_ref local_sha remote_ref remote_sha; do
    REMOTE_REF=$remote_ref
    REMOTE_SHA=$remote_sha
    LOCAL_SHA=$local_sha
done

# If nothing to push, exit
if [ "$LOCAL_SHA" = "0000000000000000000000000000000000000000" ]; then
    echo -e "${YELLOW}Nothing to push${NC}"
    exit 0
fi

# Determine the range of commits to review
if [ "$REMOTE_SHA" = "0000000000000000000000000000000000000000" ]; then
    # New branch - review last commit only
    RANGE="HEAD~1..HEAD"
    echo -e "${BLUE}ğŸ“ New branch detected - reviewing latest commit${NC}"
else
    # Existing branch - review all commits since remote
    RANGE="$REMOTE_SHA..$LOCAL_SHA"
    COMMIT_COUNT=$(git rev-list --count $RANGE)
    echo -e "${BLUE}ğŸ“ Reviewing $COMMIT_COUNT commit(s) since remote${NC}"
fi

# Get all changed files in the range
CHANGED_FILES=$(git diff --name-only $RANGE)

if [ -z "$CHANGED_FILES" ]; then
    echo -e "${GREEN}âœ… No changes to review${NC}"
    exit 0
fi

FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l | tr -d ' ')
echo -e "${BLUE}ğŸ“ Changed files: $FILE_COUNT${NC}"

# Get total line changes
STATS=$(git diff --shortstat $RANGE)
echo -e "${BLUE}ğŸ“Š Changes: $STATS${NC}"
echo ""

# Check for critical paths
echo -e "${BLUE}ğŸ” Checking for critical code paths...${NC}"
CRITICAL_FILES=""

if [ -f "$CONFIG_FILE" ]; then
    # Extract critical path patterns from config
    while IFS= read -r line; do
        if echo "$line" | grep -q "pattern:"; then
            PATTERN=$(echo "$line" | sed 's/.*pattern: "\(.*\)".*/\1/')

            # Convert glob to grep pattern
            GREP_PATTERN=$(echo "$PATTERN" | sed 's/\*\*/.*/' | sed 's/\*/[^\/]*/')

            # Check each changed file
            while IFS= read -r file; do
                if echo "$file" | grep -qE "$GREP_PATTERN"; then
                    CRITICAL_FILES="$CRITICAL_FILES\n  ğŸ”’ $file"
                fi
            done <<< "$CHANGED_FILES"
        fi
    done < <(sed -n '/^critical_paths:/,/^[^ ]/p' "$CONFIG_FILE")
fi

if [ -n "$CRITICAL_FILES" ]; then
    echo -e "${RED}ğŸ”’ CRITICAL PATHS DETECTED:${NC}"
    echo -e "$CRITICAL_FILES"
    echo -e "${RED}   These paths require mandatory code review!${NC}"
    echo ""
    REQUIRE_REVIEW=true
else
    echo -e "${GREEN}âœ“ No critical paths in changes${NC}"
    echo ""
    REQUIRE_REVIEW=false
fi

# Check if @codereview was run recently
echo -e "${BLUE}ğŸ” Checking for recent code reviews...${NC}"
LAST_REVIEW_COMMIT=$(git log --grep="@codereview\|codereview" --format="%H" -1 || echo "")

if [ -z "$LAST_REVIEW_COMMIT" ]; then
    echo -e "${YELLOW}âš ï¸  No @codereview found in commit history${NC}"
    NEEDS_REVIEW=true
else
    # Check if review is recent (within the commits being pushed)
    if git merge-base --is-ancestor "$LAST_REVIEW_COMMIT" "$LOCAL_SHA"; then
        COMMITS_SINCE_REVIEW=$(git rev-list --count "$LAST_REVIEW_COMMIT..$LOCAL_SHA" || echo "999")

        if [ "$COMMITS_SINCE_REVIEW" -eq 0 ]; then
            echo -e "${GREEN}âœ“ Code review found in most recent commit${NC}"
            NEEDS_REVIEW=false
        elif [ "$COMMITS_SINCE_REVIEW" -le 3 ]; then
            echo -e "${YELLOW}âš ï¸  Last review was $COMMITS_SINCE_REVIEW commit(s) ago${NC}"
            NEEDS_REVIEW=false
        else
            echo -e "${RED}âš ï¸  Last review was $COMMITS_SINCE_REVIEW commit(s) ago${NC}"
            NEEDS_REVIEW=true
        fi
    else
        echo -e "${YELLOW}âš ï¸  No recent code review found${NC}"
        NEEDS_REVIEW=true
    fi
fi
echo ""

# Determine if we should block
SHOULD_BLOCK=false

if [ "$REQUIRE_REVIEW" = true ] && [ "$NEEDS_REVIEW" = true ]; then
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}âŒ PUSH BLOCKED - Code Review Required${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ“‹ You are modifying CRITICAL CODE PATHS:${NC}"
    echo -e "$CRITICAL_FILES"
    echo ""
    echo -e "${YELLOW}ğŸ”’ Security Policy: Critical paths require code review${NC}"
    echo ""
    echo -e "${BLUE}To proceed:${NC}"
    echo "  1. Run @codereview in GitHub Copilot chat"
    echo "  2. Review and fix any CRITICAL/HIGH issues"
    echo "  3. Commit the fixes"
    echo "  4. Try pushing again"
    echo ""
    echo -e "${RED}  To bypass (NOT RECOMMENDED): git push --no-verify${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

    SHOULD_BLOCK=true
fi

# Run @codereview if auto_run enabled or critical paths detected
if [ "$AUTO_RUN" = "true" ] || [ "$REQUIRE_REVIEW" = true ]; then
    echo -e "${BLUE}ğŸ¤– Running @codereview automatically...${NC}"
    echo ""

    # Check if GitHub Copilot CLI is available
    if ! command -v gh &> /dev/null || ! gh copilot --version &> /dev/null 2>&1; then
        echo -e "${YELLOW}âš ï¸  GitHub Copilot CLI not found${NC}"
        echo -e "${YELLOW}   Install: https://docs.github.com/en/copilot/github-copilot-in-the-cli${NC}"
        echo ""

        if [ "$SHOULD_BLOCK" = true ]; then
            echo -e "${RED}âŒ Cannot proceed - Copilot CLI required for critical paths${NC}"
            exit 1
        fi

        echo -e "${YELLOW}âš ï¸  Please run @codereview manually in your IDE${NC}"
        echo -e "${YELLOW}   Allowing push, but review is strongly recommended${NC}"
        exit 0
    fi

    # Save diff to temporary file for review
    TEMP_DIFF=$(mktemp)
    git diff $RANGE > "$TEMP_DIFF"
    DIFF_SIZE=$(wc -l < "$TEMP_DIFF" | tr -d ' ')

    echo -e "${BLUE}ğŸ“ Generated diff: $DIFF_SIZE lines${NC}"

    if [ "$DIFF_SIZE" -gt 5000 ]; then
        echo -e "${YELLOW}âš ï¸  Very large diff ($DIFF_SIZE lines) - review may take longer${NC}"
    fi

    # Create review prompt
    REVIEW_PROMPT="Review the following git diff for security, bugs, and quality issues:\n\n"
    REVIEW_PROMPT+="Files changed: $FILE_COUNT\n"
    REVIEW_PROMPT+="Range: $RANGE\n\n"
    REVIEW_PROMPT+="Focus on:\n"
    REVIEW_PROMPT+="- CRITICAL and HIGH severity issues\n"
    REVIEW_PROMPT+="- Security vulnerabilities\n"
    REVIEW_PROMPT+="- Bugs and logic errors\n\n"
    REVIEW_PROMPT+="Diff:\n"
    REVIEW_PROMPT+="$(cat "$TEMP_DIFF")"

    # Run Copilot review (this is a simulation - actual implementation would use gh copilot API)
    echo -e "${BLUE}â³ Analyzing code with GitHub Copilot agents...${NC}"
    echo -e "${BLUE}   This may take 30-60 seconds...${NC}"
    echo ""

    # In real implementation, this would call:
    # REVIEW_RESULT=$(gh copilot suggest "@codereview" --input "$TEMP_DIFF")

    # For now, we simulate checking for indicators that review should block
    # Check git log for review results from commit messages
    REVIEW_RESULT=$(git log $RANGE --format="%B" | grep -i "critical\|security\|vulnerability" || echo "")

    rm -f "$TEMP_DIFF"

    if [ -n "$REVIEW_RESULT" ]; then
        echo -e "${YELLOW}âš ï¸  Potential issues detected in commit messages${NC}"
        echo -e "${YELLOW}   Please verify all issues are addressed${NC}"
        echo ""
    fi

    # Check for common security indicators in the diff
    SECURITY_ISSUES=$(git diff $RANGE | grep -E "password.*=|api[_-]?key.*=|secret.*=|token.*=|SELECT.*FROM.*WHERE.*\+|exec\(|eval\(" | head -5)

    if [ -n "$SECURITY_ISSUES" ]; then
        echo -e "${RED}ğŸ”´ Potential security issues detected in diff:${NC}"
        echo "$SECURITY_ISSUES" | while read -r line; do
            echo -e "${YELLOW}  âš ï¸  $line${NC}"
        done
        echo ""
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${RED}âŒ PUSH BLOCKED - Security Issues Detected${NC}"
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        echo -e "${YELLOW}Action Required:${NC}"
        echo "  1. Review the security issues listed above"
        echo "  2. Run @codereview in GitHub Copilot for detailed analysis"
        echo "  3. Fix all CRITICAL issues"
        echo "  4. Commit fixes and push again"
        echo ""
        echo -e "${RED}  To bypass (DANGEROUS): git push --no-verify${NC}"
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

        if [ "$BLOCK_ON_CRITICAL" = "true" ]; then
            exit 1
        fi
    fi
fi

# Final summary
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

if [ "$SHOULD_BLOCK" = true ] && [ "$BLOCK_ON_CRITICAL" = "true" ]; then
    echo -e "${RED}âŒ Push blocked - see errors above${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    exit 1
else
    echo -e "${GREEN}âœ… Pre-push validation passed${NC}"
    echo -e "${GREEN}   Pushing $COMMIT_COUNT commit(s) to remote${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    exit 0
fi
